# OAç³»ç»Ÿå¾®å‰ç«¯è¯´æ˜æ–‡æ¡£

[Githubæ–‡æ¡£](https://github.com/micro-zoe/micro-app/issues/8)

## ä¸€ã€å…³äºå¾®å‰ç«¯

### 1. å¾®å‰ç«¯æ˜¯ä»€ä¹ˆï¼Ÿ

**ç®€ä»‹ï¼š**

        å®ƒå€Ÿé‰´äº†å¾®æœåŠ¡çš„æ¶æ„ç†å¿µï¼Œæ ¸å¿ƒåœ¨äºå°†ä¸€ä¸ªåºå¤§çš„å‰ç«¯åº”ç”¨æ‹†åˆ†æˆå¤šä¸ªç‹¬ç«‹çµæ´»çš„å°å‹åº”ç”¨ï¼Œæ¯ä¸ªåº”ç”¨éƒ½å¯ä»¥ç‹¬ç«‹å¼€å‘ã€ç‹¬ç«‹è¿è¡Œã€ç‹¬ç«‹éƒ¨ç½²ï¼Œå†å°†è¿™äº›å°å‹åº”ç”¨èåˆä¸ºä¸€ä¸ªå®Œæ•´çš„åº”ç”¨ï¼Œæˆ–è€…å°†åŸæœ¬è¿è¡Œå·²ä¹…ã€æ²¡æœ‰å…³è”çš„å‡ ä¸ªåº”ç”¨èåˆä¸ºä¸€ä¸ªåº”ç”¨ã€‚å¾®å‰ç«¯æ—¢å¯ä»¥å°†å¤šä¸ªé¡¹ç›®èåˆä¸ºä¸€ï¼Œåˆå¯ä»¥å‡å°‘é¡¹ç›®ä¹‹é—´çš„è€¦åˆï¼Œæå‡é¡¹ç›®æ‰©å±•æ€§ï¼Œç›¸æ¯”ä¸€æ•´å—çš„å‰ç«¯ä»“åº“ï¼Œå¾®å‰ç«¯æ¶æ„ä¸‹çš„å‰ç«¯ä»“åº“å€¾å‘äºæ›´å°æ›´çµæ´»ã€‚



å¾®å‰ç«¯æ˜¯å°†ä¸åŒçš„åŠŸèƒ½æŒ‰ç…§ä¸åŒç»´åº¦æ‹†åˆ†æˆå¤šä¸ªå­åº”ç”¨ã€‚é€šè¿‡ä¸»åº”ç”¨çš„éœ€æ±‚æ¥åŠ è½½ç›¸åº”çš„å­åº”ç”¨ï¼›

å¾®å‰ç«¯æ¶æ„å…·å¤‡ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒä»·å€¼ï¼š

- æŠ€æœ¯æ ˆæ— å…³
  ä¸»æ¡†æ¶ä¸é™åˆ¶æ¥å…¥åº”ç”¨çš„æŠ€æœ¯æ ˆï¼Œå¾®åº”ç”¨å…·å¤‡å®Œå…¨è‡ªä¸»æƒ

- ç‹¬ç«‹å¼€å‘ã€ç‹¬ç«‹éƒ¨ç½²
  å¾®åº”ç”¨ä»“åº“ç‹¬ç«‹ï¼Œå‰åç«¯å¯ç‹¬ç«‹å¼€å‘ï¼Œéƒ¨ç½²å®Œæˆåä¸»æ¡†æ¶è‡ªåŠ¨å®ŒæˆåŒæ­¥æ›´æ–°

- å¢é‡å‡çº§
  
  åœ¨é¢å¯¹å„ç§å¤æ‚åœºæ™¯æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸å¾ˆéš¾å¯¹ä¸€ä¸ªå·²ç»å­˜åœ¨çš„ç³»ç»Ÿåšå…¨é‡çš„æŠ€æœ¯æ ˆå‡çº§æˆ–é‡æ„ï¼Œè€Œå¾®å‰ç«¯æ˜¯ä¸€ç§éå¸¸å¥½çš„å®æ–½æ¸è¿›å¼é‡æ„çš„æ‰‹æ®µå’Œç­–ç•¥

- ç‹¬ç«‹è¿è¡Œæ—¶
  æ¯ä¸ªå¾®åº”ç”¨ä¹‹é—´çŠ¶æ€éš”ç¦»ï¼Œè¿è¡Œæ—¶çŠ¶æ€ä¸å…±äº«





### 2. ä¸ºä»€ä¹ˆå»ä½¿ç”¨å¾®å‰ç«¯ï¼Ÿ

- ä¸åŒå›¢é˜Ÿå¼€å‘åŒä¸€ä¸ªåº”ç”¨ï¼Œä½¿ç”¨ä¸åŒçš„æŠ€æœ¯æ ˆï¼›
- æ¯ä¸ªå›¢é˜Ÿå¯ä»¥ç‹¬ç«‹å¼€å‘ç‹¬ç«‹éƒ¨ç½²ï¼›
- è€ä»£ç çš„åµŒå…¥ï¼›
- éšç€é¡¹ç›®è¿­ä»£åº”ç”¨è¶Šæ¥è¶Šåºå¤§ï¼Œéš¾ä»¥ç»´æŠ¤ã€‚

æˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥å°†ä¸€ä¸ªåº”ç”¨åˆ’åˆ†æˆè‹¥å¹²ä¸ªå­åº”ç”¨ï¼Œå°†å­åº”ç”¨æ‰“åŒ…æˆä¸€ä¸ªä¸ªlibã€‚é€šè¿‡åˆ‡æ¢è·¯ç”±æ¥åŠ è½½ä¸åŒçš„å­åº”ç”¨ã€‚è¿™æ ·æ¯ä¸ªå­åº”ç”¨éƒ½æ˜¯ç‹¬ç«‹çš„ï¼ŒæŠ€æœ¯æ ˆä¹Ÿä¸ç”¨åšé™åˆ¶ã€‚

## äºŒã€ä¸»æµå¾®å‰ç«¯æŠ€æœ¯

### 1. single-spa

2018å¹´å¼€æºçš„å¾®å‰ç«¯æ¡†æ¶ï¼Œæ˜¯ä¸€ä¸ªç”¨äºå¾®å‰ç«¯æœåŠ¡åŒ–çš„JavaScriptå‰ç«¯è§£å†³æ–¹æ¡ˆï¼Œå®ç°äº†è·¯ç”±åŠ«æŒå’Œåº”ç”¨åŠ è½½ï¼›

ç¼ºç‚¹ï¼š

- æ²¡æœ‰å¤„ç†çˆ¶å­åº”ç”¨æˆ–å¹³çº§åº”ç”¨æ ·å¼éš”ç¦»çš„é—®é¢˜ï¼›
- JavaScriptæ‰§è¡Œéš”ç¦»å¦‚çˆ¶å­åº”ç”¨æˆ–å¹³çº§åº”ç”¨ä½¿ç”¨windowå¯¹è±¡çš„å†²çªé—®é¢˜ï¼›

### 2. qiankun

åŸºäº`single-spa`ï¼Œä¸”æä¾›äº†å¼€ç®±å³ç”¨çš„APIï¼ˆsandbox+import-html-entryï¼‰,ä¸æŠ€æœ¯æ— å…³ï¼›

**ä¼˜ç‚¹ï¼š**

- å¼€ç®±å³ç”¨çš„API

- **HTML Entry æ¥å…¥æ–¹å¼**ï¼Œè®©ä½ æ¥å…¥å¾®åº”ç”¨åƒä½¿ç”¨ iframe ä¸€æ ·ç®€å•ã€‚

- **æŠ€æœ¯æ ˆæ— å…³**ï¼Œä»»æ„æŠ€æœ¯æ ˆçš„åº”ç”¨å‡å¯ ä½¿ç”¨/æ¥å…¥ï¼›

- **æ ·å¼éš”ç¦»**ï¼Œç¡®ä¿å¾®åº”ç”¨ä¹‹é—´æ ·å¼äº’ç›¸ä¸å¹²æ‰°ã€‚

- **JS æ²™ç®±**ï¼Œç¡®ä¿å¾®åº”ç”¨ä¹‹é—´ å…¨å±€å˜é‡/äº‹ä»¶ ä¸å†²çªã€‚

- **èµ„æºé¢„åŠ è½½**ï¼Œåœ¨æµè§ˆå™¨ç©ºé—²æ—¶é—´é¢„åŠ è½½æœªæ‰“å¼€çš„å¾®åº”ç”¨èµ„æºï¼ŒåŠ é€Ÿå¾®åº”ç”¨æ‰“å¼€é€Ÿåº¦ã€‚

- **umi æ’ä»¶**ï¼Œæä¾›äº† [@umijs/plugin-qiankun](https://github.com/umijs/plugins/tree/master/packages/plugin-qiankun) ä¾› umi åº”ç”¨ä¸€é”®åˆ‡æ¢æˆå¾®å‰ç«¯æ¶æ„ç³»ç»Ÿã€‚

**ç¼ºç‚¹ï¼š**

- åŸºäºURLçš„æ–¹å¼æ— æ³•åœ¨ä¸€ä¸ªé¡µé¢ä¸ŠåŒæ—¶åŠ è½½å¤šä¸ªå­åº”ç”¨ï¼Œæ¯•ç«Ÿæµè§ˆå™¨çš„URLä¹Ÿåªæœ‰ä¸€ä¸ªï¼ˆ`single-spa`æ˜¯é€šè¿‡ç›‘å¬ url change äº‹ä»¶ï¼Œåœ¨è·¯ç”±å˜åŒ–æ—¶åŒ¹é…åˆ°æ¸²æŸ“çš„å­åº”ç”¨å¹¶è¿›è¡Œæ¸²æŸ“ï¼Œè¿™ä¸ªæ€è·¯ä¹Ÿæ˜¯ç›®å‰å®ç°å¾®å‰ç«¯çš„ä¸»æµæ–¹å¼ï¼‰
- ä¾µå…¥ä»£ç è¾ƒå¤šï¼Œ`single-spa`è¦æ±‚å­åº”ç”¨ä¿®æ”¹æ¸²æŸ“é€»è¾‘å¹¶æš´éœ²å‡ºä¸‰ä¸ªæ–¹æ³•ï¼š`bootstrap`ã€`mount`ã€`unmount`ï¼Œåˆ†åˆ«å¯¹åº”åˆå§‹åŒ–ã€æ¸²æŸ“å’Œå¸è½½ï¼Œè¿™ä¹Ÿå¯¼è‡´å­åº”ç”¨éœ€è¦å¯¹å…¥å£æ–‡ä»¶è¿›è¡Œä¿®æ”¹ã€‚

### 3. mirco-app

`micro-app`å¹¶æ²¡æœ‰æ²¿è¢­`single-spa`çš„æ€è·¯ï¼Œè€Œæ˜¯å€Ÿé‰´äº†WebComponentçš„æ€æƒ³ï¼Œé€šè¿‡CustomElementç»“åˆè‡ªå®šä¹‰çš„ShadowDomï¼Œå°†å¾®å‰ç«¯å°è£…æˆä¸€ä¸ªç±»WebComponentç»„ä»¶ï¼Œä»è€Œå®ç°å¾®å‰ç«¯çš„ç»„ä»¶åŒ–æ¸²æŸ“ã€‚å¹¶ä¸”ç”±äºè‡ªå®šä¹‰ShadowDomçš„éš”ç¦»ç‰¹æ€§ï¼Œ`micro-app`ä¸éœ€è¦åƒ`single-spa`å’Œ`qiankun`ä¸€æ ·è¦æ±‚å­åº”ç”¨ä¿®æ”¹æ¸²æŸ“é€»è¾‘å¹¶æš´éœ²å‡ºæ–¹æ³•ï¼Œä¹Ÿä¸éœ€è¦ä¿®æ”¹webpacké…ç½®ï¼Œæ˜¯ç›®å‰å¸‚é¢ä¸Šæ¥å…¥å¾®å‰ç«¯æˆæœ¬æœ€ä½çš„æ–¹æ¡ˆã€‚

**é€‰æ‹©mirco-appåŸå› ï¼š**

- ä¸æƒ³åŸºäºè·¯ç”±çš„æ–¹å¼æ¥é™åˆ¶å­ç»„ä»¶çš„ï¼›

- ä¸€ä¸ªé¡µé¢ä¸‹ä¼šæœ‰å¤šä¸ªå­ç»„ä»¶çš„æƒ…å†µï¼›

### 4. ä¸ºä»€ä¹ˆä¸ç”¨ifarmï¼Ÿ

1ã€URLä¸åŒæ­¥é—®é¢˜ï¼Œæµè§ˆå™¨åˆ·æ–°åiframe urlçŠ¶æ€ä¸¢å¤±ã€åé€€å‰æ™¯æŒ‰é’®æ— æ³•æ­£å¸¸ä½¿ç”¨ï¼›

2ã€æ…¢ã€‚æ¯æ¬¡å­åº”ç”¨è¿›å…¥éƒ½æ˜¯ä¸€æ¬¡æµè§ˆå™¨ä¸Šä¸‹æ–‡é‡å»ºã€èµ„æºé‡æ–°åŠ è½½çš„è¿‡ç¨‹ã€‚

3ã€UI ä¸åŒæ­¥ï¼ŒDOM ç»“æ„ä¸å…±äº«ã€‚æƒ³è±¡ä¸€ä¸‹å±å¹•å³ä¸‹è§’ 1/4 çš„ iframe é‡Œæ¥ä¸€ä¸ªå¸¦é®ç½©å±‚çš„å¼¹æ¡†ï¼ŒåŒæ—¶æˆ‘ä»¬è¦æ±‚è¿™ä¸ªå¼¹æ¡†è¦æµè§ˆå™¨å±…ä¸­æ˜¾ç¤ºï¼Œè¿˜è¦æµè§ˆå™¨ resize æ—¶è‡ªåŠ¨å±…ä¸­ã€‚

4ã€å…¨å±€ä¸Šä¸‹æ–‡å®Œå…¨éš”ç¦»ï¼Œå†…å­˜å˜é‡ä¸å…±äº«ã€‚iframe å†…å¤–ç³»ç»Ÿçš„é€šä¿¡ã€æ•°æ®åŒæ­¥ç­‰éœ€æ±‚ï¼Œä¸»åº”ç”¨çš„ cookie è¦é€ä¼ åˆ°æ ¹åŸŸåéƒ½ä¸åŒçš„å­åº”ç”¨ä¸­å®ç°å…ç™»æ•ˆæœã€‚

å‚è€ƒåœ°å€ [Why Not Iframe](https://www.yuque.com/kuitos/gky7yw/gesexv)



å…¶å®ï¼Œåœ¨æ‰€æœ‰å¾®å‰ç«¯æ–¹æ¡ˆä¸­ï¼Œiframeæ˜¯æœ€ç¨³å®šçš„ã€ä¸Šæ‰‹éš¾åº¦æœ€ä½çš„ï¼Œä½†å®ƒæœ‰ä¸€äº›æ— æ³•è§£å†³çš„é—®é¢˜ï¼Œä¾‹å¦‚æ€§èƒ½ä½ã€é€šä¿¡å¤æ‚ã€åŒæ»šåŠ¨æ¡ã€å¼¹çª—æ— æ³•å…¨å±€è¦†ç›–ï¼Œå®ƒçš„æˆé•¿æ€§ä¸é«˜ï¼Œåªé€‚åˆç®€å•çš„é¡µé¢æ¸²æŸ“ã€‚



### 5. **npmåŒ…**

å°†å­åº”ç”¨å°è£…æˆnpmåŒ…ï¼Œé€šè¿‡ç»„ä»¶çš„æ–¹å¼å¼•å…¥ï¼Œåœ¨æ€§èƒ½å’Œå…¼å®¹æ€§ä¸Šæ˜¯æœ€ä¼˜çš„æ–¹æ¡ˆï¼Œä½†å´æœ‰ä¸€ä¸ªè‡´å‘½çš„é—®é¢˜å°±æ˜¯ç‰ˆæœ¬æ›´æ–°ï¼Œæ¯æ¬¡ç‰ˆæœ¬å‘å¸ƒéœ€è¦é€šçŸ¥æ¥å…¥æ–¹åŒæ­¥æ›´æ–°ï¼Œç®¡ç†éå¸¸å›°éš¾ã€‚

## ä¸‰ã€ä¸»åº”ç”¨é…ç½®

### 1. ä¸»åº”ç”¨å¼•å…¥

```js
// main.js
import microApp from '@micro-zoe/micro-app'
microApp.start()
```

### 2. é…ç½®å­åº”ç”¨ç«¯å£

å­åº”ç”¨ç«¯å£éœ€å’Œä¸»åº”ç”¨ç«¯å£ä¸€ä¸€å¯¹åº”ï¼Œæ³¨æ„ï¼šé¿å…ç«¯å£å·çš„å ç”¨é—®é¢˜ï¼Œå°½é‡ä½¿ç”¨ç©ºé—²çš„ç«¯å£å·ï¼Œï¼ˆå¼€å‘ç¯å¢ƒä½¿ç”¨ï¼‰

```js
// ä¸»åº”ç”¨ src\micro-app\port-config.js
...
const config = [{
    name: 'base',                    // å­åº”ç”¨åç§°
    port: 'http://localhost:4001/',  // å­åº”ç”¨ç«¯å£
  },
  {
    name: 'flow',
    port: 'http://localhost:4002/',
  }, {
    name: 'hiring',
    port: 'http://localhost:4003/',
  }
]
...
```

ç”Ÿäº§ç¯å¢ƒä½¿ç”¨

```js
// ä¸»åº”ç”¨ src\micro-app\port-config.js
...
if (process.env.NODE_ENV === 'production') {
  // åŸºåº§åº”ç”¨å’Œå­åº”ç”¨éƒ¨ç½²åœ¨åŒä¸€ä¸ªåŸŸåä¸‹ï¼Œè¿™é‡Œä½¿ç”¨location.originè¿›è¡Œè¡¥å…¨
  config.forEach(item => {
    item.port = `${window.location.origin}/${item.name}/`
  })
}
...
```

### 3. ä¸»åº”ç”¨è·¯ç”±é…ç½®

ä¸»åº”ç”¨é‡‡ç”¨historyæ¨¡å¼

```js
// src\router\index.js
// ä¸»åº”ç”¨ä¸­æ·»åŠ å­åº”ç”¨åç§°å¯¹åº”çš„è·¯ç”±
let index = routes.findIndex(item => item.path == "/main")
routes[index].children = routes[index].children.concat(microRoute())
```

```js
// src\micro-app\port-config.js
export const microRoute = () => {
  let arr = []
  microConfig.forEach(subApp => {
    arr.push({
      path: subApp.name + '/#/', // è¿™é‡Œè¦æŠŠçˆ¶è·¯ç”±çš„è·¯å¾„ä¹Ÿå¸¦ä¸Š
      name: subApp.name,
      component: () => import('@/micro-app/component/subCommon'),
    }, {
      path: subApp.name + '/*', // é˜²æ­¢ä¸»åº”ç”¨åˆ·æ–°å²404
    }, )
  });
  return arr
}
```

### 4. å­åº”ç”¨æ¸²æŸ“ç»„ä»¶

- ç«¯å£ `url` é…ç½®å’Œ`name` é…ç½®å¿…é¡»æ˜¯ç‹¬ä¸€æ— äºŒçš„ï¼›

- ç›‘å¬æ¯ä¸ªå­ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°å¦‚ï¼š`@created``@beforemount``@mounted`å’Œ`@unmount` ç­‰ï¼›

- é€šè¿‡ `:data`å¯¹å­ç»„ä»¶è¿›è¡Œä¼ å‚ï¼›

```html
<template>
    <div>
        <div v-for="subApp in microApps" :key="subApp.name">
            <micro-app
                v-if="mountedFlag"
                v-show="isShow === subApp.name"
                :name="subApp.name"
                :url="subApp.port"
                @created="created(subApp.name)"
                @beforemount="beforemount(subApp.name)"
                @mounted="mounted(subApp.name)"
                @unmount="unmount(subApp.name)"
                :data="microData"
                keep-alive
            ></micro-app>
        </div>
    </div>
</template>
```

## å››ã€å­åº”ç”¨é…ç½®

### 1. å­åº”ç”¨ç«¯å£é…ç½®

```js
// å­åº”ç”¨ï¼Œvueçš„é…ç½®æ–‡ä»¶
// config\index.js
...
module.exports = {
  ...
  dev: {
    ...
    host: '127.0.0.1', // can be overwritten by process.env.HOST
    port: 4001, // ä¸ä¸»åº”ç”¨çš„ç«¯å£å·ä¸€è‡´
    ...
  },
  ...
}
```

### 2. è®¾ç½®è·¨åŸŸæ”¯æŒ

- vue-cli > 3.*

    åœ¨`vue.config.js`ä¸­æ·»åŠ é…ç½®

```js
devServer: {
    headers: {    // æ”¯æŒè·¨åŸŸ
      'Access-Control-Allow-Origin': '*',
    }
}
```

- vue-cli 2.*

`webpack.dev.conf.js`ä¸­æ·»åŠ é…ç½®

```js
devServer: {
    headers: {    // æ”¯æŒè·¨åŸŸ
      'Access-Control-Allow-Origin': '*',
    }
}
```

### 3. è®¾ç½® publicPath

å€ŸåŠ©äº†webpackçš„åŠŸèƒ½ï¼Œé¿å…å­åº”ç”¨çš„é™æ€èµ„æºä½¿ç”¨ç›¸å¯¹åœ°å€æ—¶åŠ è½½å¤±è´¥çš„æƒ…å†µ;

**æ­¥éª¤1:** åœ¨å­åº”ç”¨srcç›®å½•ä¸‹åˆ›å»ºåç§°ä¸º`public-path.js`çš„æ–‡ä»¶ï¼Œå¹¶æ·»åŠ å¦‚ä¸‹å†…å®¹

```js
// __MICRO_APP_ENVIRONMENT__å’Œ__MICRO_APP_PUBLIC_PATH__æ˜¯ç”±micro-appæ³¨å…¥çš„å…¨å±€å˜é‡
if (window.__MICRO_APP_ENVIRONMENT__) {
  // eslint-disable-next-line
  __webpack_public_path__ = window.__MICRO_APP_PUBLIC_PATH__
}
```

**æ­¥éª¤2:** åœ¨å­åº”ç”¨å…¥å£æ–‡ä»¶çš„`æœ€é¡¶éƒ¨`å¼•å…¥`public-path.js`

```js
// entry
import './public-path'
```

### 4. å…¬å…±è·¯å¾„ï¼ˆ*publicPath*ï¼‰

åœ¨æ–°å»ºä¸€ä¸ªæ–°çš„å­åº”ç”¨æ—¶ï¼Œå»ºè®®å¼€å‘ç¯å¢ƒå’Œçº¿ä¸Šç¯å¢ƒè·¯å¾„ä¿æŒä¸€è‡´ï¼Œè¿™æ ·å¼€å‘ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒçš„èµ„æºè·¯å¾„å°±ä¸ç”¨è¿›è¡Œè½¬æ¢ã€‚

- vue-cli > 3.* ï¼Œåœ¨`vue.config.js`ä¸­é…ç½®ï¼›

```js
// vue.config.js
module.exports = {
  outputDir: 'my-app',
  // publicPath: process.env.NODE_ENV === 'production' ? '/base' : '', // bad âŒ
  publicPath: '/base', // good ğŸ‘
}
```

- vue-cli 2.*ï¼Œåœ¨`webpack.dev.conf.js`ä¸­é…ç½®ï¼›

```js
// webpack.config.js
module.exports = {
  output: {
    path: 'my-app',
    // publicPath: process.env.NODE_ENV === 'production' ? '/base' : '', // bad âŒ
    publicPath: '/base', // good ğŸ‘
  }
}
```

### 5. ç›‘å¬å­åº”ç”¨å¸è½½

å­åº”ç”¨è¢«å¸è½½æ—¶ä¼šæ¥å—åˆ°ä¸€ä¸ªåä¸º`unmount`çš„äº‹ä»¶ï¼Œåœ¨æ­¤å¯ä»¥è¿›è¡Œå¸è½½ç›¸å…³æ“ä½œã€‚

```js
// main.js
const app = new Vue(...)

// ç›‘å¬å¸è½½æ“ä½œ
window.microApp && window.addEventListener('unmount', function () {
  console.log('æˆ‘æ˜¯å­åº”ç”¨baseã€‚å¸è½½...');
  app1.$destroy()
  app1.$el.innerHTML = ''
  app1 = null
})
```

### 6. æ¥æ”¶ä¸»åº”ç”¨ä¸‹å‘è·¯ç”±è·³è½¬

æ–¹å¼ä¸€ï¼šwindow.historyæ¨¡å¼

```js
// main.js
window.microApp && window.microApp.addDataListener((data) => {
  // å½“åŸºåº§ä¸‹å‘è·³è½¬æŒ‡ä»¤æ—¶è¿›è¡Œè·³è½¬
  if (data.path) {
    router.push({path: `/main/${data.path}`})
  }
})
```

æ–¹å¼äºŒï¼šé€šè¿‡æ•°æ®é€šä¿¡æ§åˆ¶è·³è½¬

ï¼ˆä¸»åº”ç”¨æ§åˆ¶å­åº”ç”¨è·³è½¬ï¼‰

```js
// ä¸»åº”ç”¨
// microAppName ä¸ºå­åº”ç”¨åç§°       path å­åº”ç”¨è·³è½¬çš„è·¯ç”±

microApp.setData(microAppName, { path: path });
```

æ–¹å¼ä¸‰ï¼š ä¼ é€’è·¯ç”±å®ä¾‹æ–¹æ³•

(å­åº”ç”¨æ§åˆ¶ä¸»åº”ç”¨æˆ–å…¶ä»–å­åº”ç”¨çš„è·³è½¬)

```v
<!-- ä¸»åº”ç”¨ -->
<template>
  <micro-app
    name='å­åº”ç”¨åç§°' 
    url='url'
    :data='microAppData'
  ></micro-app>
</template>

<script>
export default {
  data () {
    return {
      microAppData: {
        pushState: (path) => {
          this.$router.push(path)
        }
      }
    }
  },
}
</script>
```

å­åº”ç”¨ä½¿ç”¨pushStateæ§åˆ¶åŸºåº§è·³è½¬ï¼š

```js
window.microApp.getData().pushState(path)
```

### 7. è·¯ç”±çº¦å®š

*** å­åº”ç”¨ä¸€å¾‹ä½¿ç”¨hashæ¨¡å¼**

**æ³¨æ„äº‹é¡¹ï¼š**

- ä¸»åº”ç”¨é‡‡ç”¨historyè·¯ç”±ï¼Œå­åº”ç”¨å¿…é¡»é‡‡ç”¨æ˜¯hashè·¯ç”±çš„æ¨¡å¼ï¼Œè¿™æ ·ä¸»åº”ç”¨å†™çš„è§„åˆ™æ‰å¯ä»¥è¿›è¡ŒåŒ¹é…ï¼›

- å­åº”ç”¨è·¯ç”±æ–°å¢åº”è¯¥åœ¨ `path: "/main"` çš„å­è·¯ç”±è¿›è¡Œé…ç½®ï¼Œä¸¾ä¸ªä¾‹å­ï¼š

```js
export default new Router({
  mode: 'hash',
  routes: [{
    ...
     {
        path: "/main",
        component: MainLayout,
        name: "desktop",
        children: [{
            path: "XXXX/XXXXXXX",
            name: "XXXXX",
            component: () => import('@/pages/XXXXX/XXXXX.vue')
         }]
      }
    ...
   }]
)}
```

- è·¯ç”±è¡¨é…ç½®æ³¨æ„äº‹é¡¹ï¼š**è¯¥æ¨¡å—ä¸­çš„è·¯ç”±`path`éœ€è¦æ˜¯æ‰€æœ‰å­åº”ç”¨ä¸­ç‹¬ä¸€æ— äºŒçš„**ï¼ˆä¸ç„¶åœ¨ä¸»åº”ç”¨è·³è½¬å­åº”ç”¨è·¯ç”±æ—¶ï¼Œä¼šå‘ç”Ÿæ··ä¹±ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºæˆ‘ä»¬çš„å­åº”ç”¨è·¯ç”±åŠ ä¸Šç‰¹å®šçš„å‰ç¼€æ¥é¿å…é‡åé—®é¢˜ï¼Œä¸¾ä¸ªä¾‹å­ï¼š
  
  ```js
  export default new Router({
    mode: 'hash',
    routes: [{
      ...
       {
          path: "/main",
          component: MainLayout,
          name: "desktop",
          children: [{
              path: "role/XXXXXXX",
              name: "XXXXX",
              component: () => import('@/pages/role/XXXXX.vue')
           }]
        }
      ...
     }]
  )}
  ```

### 8. åº”ç”¨ä¹‹é—´çš„è·³è½¬

æ¯ä¸ªåº”ç”¨çš„è·¯ç”±å®ä¾‹éƒ½æ˜¯ä¸åŒçš„ï¼Œåº”ç”¨çš„è·¯ç”±å®ä¾‹åªèƒ½æ§åˆ¶è‡ªèº«ï¼Œæ— æ³•å½±å“å…¶å®ƒåº”ç”¨ï¼ŒåŒ…æ‹¬åŸºåº§åº”ç”¨æ— æ³•é€šè¿‡æ§åˆ¶è‡ªèº«è·¯ç”±å½±å“åˆ°å­åº”ã€‚

**è¦å®ç°åº”ç”¨ä¹‹é—´çš„è·³è½¬æ–¹å¼ï¼š**

- **window.history**

```js
// ä¿®æ”¹æµè§ˆå™¨URL
window.history.pushState(null, '', '#/page2')
// ä¸»åŠ¨è§¦å‘ä¸€æ¬¡popstateäº‹ä»¶
window.dispatchEvent(new PopStateEvent('popstate', { state: null }))
```

### 9. å­åº”ç”¨å·¦ä¾§æ éšè—å¤„ç†

ä¸ºäº†ä¿è¯å­åº”ç”¨å¯ä»¥è„±ç¦»ä¸»åº”ç”¨ç‹¬ç«‹å¼€å‘ï¼Œä¿ç•™äº†åŸæœ‰çš„ç™»é™†åŠŸèƒ½å’Œä¸»åº”ç”¨æœ‰çš„ä¾§è¾¹æ åŠŸèƒ½ã€‚ä»…å¯¹ä¾§è¾¹æ é¡µé¢åœ¨ `å¾®å‰ç«¯ç¯å¢ƒ` ä¸‹éšè—ï¼Œåœ¨ `ç‹¬ç«‹å¼€å‘ç¯å¢ƒ` ä¸‹æ˜¾ç¤ºï¼Œæ§åˆ¶å­—æ®µå¦‚ä¸‹ï¼š

```js
computed: {
    isMicroApp() {
      return this.$store.state.isMicroApp
    }
},
```

## äº”ã€ æ‰“åŒ…éƒ¨ç½²

### 1. åº”ç”¨æ‰“åŒ…

- é…ç½®æ‰“åŒ…åç§°ï¼Œé…ç½®æ–‡ä»¶`config\index.js`ï¼ˆå¯é€‰ï¼‰

```js
// åœ¨baseå­åº”ç”¨ä¸­
// config\index.js
...
build: {
    // æ‰“åŒ…çš„indexæ–‡ä»¶ç›®å½•
    index: path.resolve(__dirname, '../dist/base/index.html'),
    // æ‰“åŒ…è¾“å‡ºPaths
    assetsRoot: path.resolve(__dirname, '../dist/base'),
}
...
```

- æ‰“åŒ…æŒ‡ä»¤

```bash
npm run build
```

- å°†æ‰“åŒ…æ–‡ä»¶ä¸Šä¼ åˆ°æŒ‡å®šçš„æœåŠ¡å™¨

### 2. éƒ¨ç½²åˆ°æœåŠ¡å™¨çš„ç›®å½•ç»“æ„ï¼š

ä½¿ç”¨Nginxè¿›è¡Œéƒ¨ç½²

```
html(nginxä¸‹å­˜æ”¾ä»£çš„ç›®å½•)
â”œâ”€â”€ child
â”‚   â”œâ”€â”€ base              // å­åº”ç”¨ base
â”‚   â”œâ”€â”€ flow              // å­åº”ç”¨ flow
â”‚   â”œâ”€â”€ hiring            // å­åº”ç”¨ hiring
â”‚ 
â”œâ”€â”€ main                  // ä¸»åº”ç”¨
```

### 3. Nginxé…ç½®

å…¶ä¸­å­åº”ç”¨çš„locationå€¼è¦äºpublicPathé…ç½®çš„è·¯å¾„ä¸€è‡´ï¼›

```apacheconf
server {
    listen       80;
    server_name  10.1.6.50;

    # ä¸»åº”ç”¨
    location / {
        root /usr/share/nginx/html/main;
        index index.html;
        # è·¨åŸŸ
        add_header Access-Control-Allow-Origin *;
        if ( $request_uri ~* ^.+.(js|css|jpg|png|gif|tif|dpg|jpeg|eot|svg|ttf|woff|json|mp4|rmvb|rm|wmv|avi|3gp)$ ){
            add_header Cache-Control max-age=7776000;
            add_header Access-Control-Allow-Origin *;
        }
        try_files $uri $uri/ /index.html;
    }            

    # å­åº”ç”¨base
    location /base {
        alias /usr/share/nginx/html/child/base/;
        add_header Access-Control-Allow-Origin *;
        if ( $request_uri ~* ^.+.(js|css|jpg|png|gif|tif|dpg|jpeg|eot|svg|ttf|woff|json|mp4|rmvb|rm|wmv|avi|3gp)$ ){
            add_header Cache-Control max-age=7776000;
            add_header Access-Control-Allow-Origin *;
        }
        try_files $uri $uri/ /html/child/base/index.html;
    }

    # å­åº”ç”¨flow
    location /flow {
        alias /usr/share/nginx/html/child/flow/;
        add_header Access-Control-Allow-Origin *;
        if ( $request_uri ~* ^.+.(js|css|jpg|png|gif|tif|dpg|jpeg|eot|svg|ttf|woff|json|mp4|rmvb|rm|wmv|avi|3gp)$ ){
            add_header Cache-Control max-age=7776000;
            add_header Access-Control-Allow-Origin *;
        }
        try_files $uri $uri/ /html/child/flow/index.html;
    }

    # å­åº”ç”¨hiring
    location /hiring {
        alias /usr/share/nginx/html/child/hiring/;
        add_header Access-Control-Allow-Origin *;
        if ( $request_uri ~* ^.+.(js|css|jpg|png|gif|tif|dpg|jpeg|eot|svg|ttf|woff|json|mp4|rmvb|rm|wmv|avi|3gp)$ ){
            add_header Cache-Control max-age=7776000;
            add_header Access-Control-Allow-Origin *;
        }
        try_files $uri $uri/ /html/child/hiring/index.html;
    }

    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   html;
    }
}
```

Dockerè¿è¡ŒæŒ‡ä»¤

```
docker stop nginx
docker rm -f nginx
docker run --name nginx -p 8080:80 -v /root/nginx/html:/usr/share/nginx/html -v /root/nginx/conf/nginx.conf:/etc/nginx/nginx.conf -v /root/nginx/logs:/var/log/nginx -d nginx
```

## å…­ã€ å…¶ä»–è¯´æ˜

### 1. ä¸»åº”ç”¨é»˜è®¤å¼€å¯é¡¹

ä¸»åº”ç”¨é»˜è®¤å¼€å¯äº†ä¸€ä¸‹åŠŸèƒ½ï¼š

- jsæ²™ç®±

- æ ·å¼éš”ç¦»

- å…ƒç´ éš”ç¦»

### 2. å…¨å±€å˜é‡é—®é¢˜

- å¼€å‘å­åº”ç”¨æ—¶ï¼Œ**æ…ç”¨æ“ä½œwindowå¯¹è±¡ç­‰å…¨å±€å˜é‡**ï¼Œé¿å…å½±å“å…¨å±€çš„ä¸»åº”ç”¨ã€‚



## ä¸ƒã€mirco-appåŸç†

### 1. æ ¸å¿ƒåŸç†

MicroApp çš„æ ¸å¿ƒåŠŸèƒ½åœ¨CustomElementåŸºç¡€ä¸Šè¿›è¡Œæ„å»ºï¼ŒCustomElementç”¨äºåˆ›å»ºè‡ªå®šä¹‰æ ‡ç­¾ï¼Œå¹¶æä¾›äº†å…ƒç´ çš„æ¸²æŸ“ã€å¸è½½ã€å±æ€§ä¿®æ”¹ç­‰é’©å­å‡½æ•°ï¼Œæˆ‘ä»¬é€šè¿‡é’©å­å‡½æ•°è·çŸ¥å¾®åº”ç”¨çš„æ¸²æŸ“æ—¶æœºï¼Œå¹¶å°†è‡ªå®šä¹‰æ ‡ç­¾ä½œä¸ºå®¹å™¨ï¼Œå¾®åº”ç”¨çš„æ‰€æœ‰å…ƒç´ å’Œæ ·å¼ä½œç”¨åŸŸéƒ½æ— æ³•é€ƒç¦»å®¹å™¨è¾¹ç•Œï¼Œä»è€Œå½¢æˆä¸€ä¸ªå°é—­çš„ç¯å¢ƒã€‚

### 2. æ¸²æŸ“æµç¨‹

é€šè¿‡è‡ªå®šä¹‰å…ƒç´ `micro-app`çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°`connectedCallback`ç›‘å¬å…ƒç´ è¢«æ¸²æŸ“ï¼ŒåŠ è½½å­åº”ç”¨çš„htmlå¹¶è½¬æ¢ä¸ºDOMç»“æ„ï¼Œé€’å½’æŸ¥è¯¢æ‰€æœ‰jså’Œcssç­‰é™æ€èµ„æºå¹¶åŠ è½½ï¼Œè®¾ç½®å…ƒç´ éš”ç¦»ï¼Œæ‹¦æˆªæ‰€æœ‰åŠ¨æ€åˆ›å»ºçš„scriptã€linkç­‰æ ‡ç­¾ï¼Œæå–æ ‡ç­¾å†…å®¹ã€‚å°†åŠ è½½çš„jsç»è¿‡æ’ä»¶ç³»ç»Ÿå¤„ç†åæ”¾å…¥æ²™ç®±ä¸­è¿è¡Œï¼Œå¯¹cssèµ„æºè¿›è¡Œæ ·å¼éš”ç¦»ï¼Œæœ€åå°†æ ¼å¼åŒ–åçš„å…ƒç´ æ”¾å…¥`micro-app`ä¸­ï¼Œæœ€ç»ˆå°†`micro-app`å…ƒç´ æ¸²æŸ“ä¸ºä¸€ä¸ªå¾®å‰ç«¯çš„å­åº”ç”¨ã€‚åœ¨æ¸²æŸ“çš„è¿‡ç¨‹ä¸­ï¼Œä¼šæ‰§è¡Œå¼€å‘è€…ç»‘å®šçš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼Œç”¨äºè¿›ä¸€æ­¥æ“ä½œã€‚

### 3. å…ƒç´ éš”ç¦»

- å…ƒç´ éš”ç¦»æºäºShadowDomçš„æ¦‚å¿µï¼Œå³ShadowDomä¸­çš„å…ƒç´ å¯ä»¥å’Œå¤–éƒ¨çš„å…ƒç´ é‡å¤ä½†ä¸ä¼šå†²çªï¼ŒShadowDomåªèƒ½å¯¹è‡ªå·±å†…éƒ¨çš„å…ƒç´ è¿›è¡Œæ“ä½œã€‚
- MicroAppæ¨¡æ‹Ÿå®ç°äº†ç±»ä¼¼çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬æ‹¦æˆªäº†åº•å±‚åŸå‹é“¾ä¸Šå…ƒç´ çš„æ–¹æ³•ï¼Œä¿è¯å­åº”ç”¨åªèƒ½å¯¹è‡ªå·±å†…éƒ¨çš„å…ƒç´ è¿›è¡Œæ“ä½œï¼Œæ¯ä¸ªå­åº”ç”¨éƒ½æœ‰è‡ªå·±çš„å…ƒç´ ä½œç”¨åŸŸã€‚
- å…ƒç´ éš”ç¦»å¯ä»¥æœ‰æ•ˆçš„é˜²æ­¢å­åº”ç”¨å¯¹åŸºåº§åº”ç”¨å’Œå…¶å®ƒå­åº”ç”¨å…ƒç´ çš„è¯¯æ“ä½œï¼Œå¸¸è§çš„åœºæ™¯æ˜¯å¤šä¸ªåº”ç”¨çš„æ ¹å…ƒç´ éƒ½ä½¿ç”¨ç›¸åŒçš„idï¼Œå…ƒç´ éš”ç¦»å¯ä»¥ä¿è¯å­åº”ç”¨çš„æ¸²æŸ“æ¡†æ¶èƒ½å¤Ÿæ­£ç¡®æ‰¾åˆ°è‡ªå·±çš„æ ¹å…ƒç´ ã€‚

### 4. æ’ä»¶ç³»ç»Ÿ

ä¸ªäººç†è§£ï¼šä¸€ä¸ªçº¯å‡€çš„ç³»ç»Ÿï¼Œæœ¬èº«ä¸ä¼šå¯¹èµ„æºé€ æˆå½±å“ï¼Œåªæ˜¯ç»Ÿç­¹æ’ä»¶å¦‚ä½•æ‰§è¡Œã€‚è®¾ç½®æ’ä»¶ä½œç”¨åœ¨çˆ¶ç»„ä»¶è¿˜æ˜¯å­ç»„ä»¶ä¸­ã€‚

### 5. jsæ²™ç®±å’Œæ ·å¼éš”ç¦»

- jsæ²™ç®±é€šè¿‡Proxyä»£ç†å­åº”ç”¨çš„å…¨å±€å¯¹è±¡ï¼Œé˜²æ­¢åº”ç”¨ä¹‹é—´å…¨å±€å˜é‡çš„å†²çªï¼Œè®°å½•æˆ–æ¸…ç©ºå­åº”ç”¨çš„å…¨å±€å‰¯ä½œç”¨å‡½æ•°ï¼Œä¹Ÿå¯ä»¥å‘å­åº”ç”¨æ³¨å…¥å…¨å±€å˜é‡ç”¨äºå®šåˆ¶åŒ–å¤„ç†ã€‚

- æ ·å¼éš”ç¦»æ˜¯æŒ‡å¯¹å­åº”ç”¨çš„linkå’Œstyleå…ƒç´ çš„csså†…å®¹è¿›è¡Œæ ¼å¼åŒ–å¤„ç†ï¼Œç¡®ä¿å­åº”ç”¨çš„æ ·å¼åªä½œç”¨åŸŸè‡ªèº«ï¼Œæ— æ³•å½±å“å¤–éƒ¨ã€‚

ï¼ˆMicroAppå€Ÿé‰´äº†qiankunçš„jsæ²™ç®±å’Œæ ·å¼éš”ç¦»æ–¹æ¡ˆï¼Œè¿™ä¹Ÿæ˜¯ç›®å‰åº”ç”¨å¹¿æ³›ä¸”æˆç†Ÿçš„æ–¹æ¡ˆï¼‰

### 6. é¢„åŠ è½½

MicroApp æä¾›äº†é¢„åŠ è½½å­åº”ç”¨çš„åŠŸèƒ½ï¼Œå®ƒæ˜¯åŸºäºrequestIdleCallbackå®ç°çš„ï¼Œé¢„åŠ è½½ä¸ä¼šå¯¹åŸºåº§åº”ç”¨å’Œå…¶å®ƒå­åº”ç”¨çš„æ¸²æŸ“é€Ÿåº¦é€ æˆå½±å“ï¼Œå®ƒä¼šåœ¨æµè§ˆå™¨ç©ºé—²æ—¶é—´åŠ è½½åº”ç”¨çš„é™æ€èµ„æºï¼Œåœ¨åº”ç”¨çœŸæ­£è¢«æ¸²æŸ“æ—¶ç›´æ¥ä»ç¼“å­˜ä¸­è·å–èµ„æºå¹¶æ¸²æŸ“ã€‚

